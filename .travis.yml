---
sudo: required
services:
  - docker
language: python
python:
  - "2.7"
  - "3.4"
env:
  - OS_NAME=centos OS_VERSION=7
  - OS_NAME=ubuntu OS_VERSION=trusty
  - OS_NAME=ubuntu OS_VERSION=xenial
before_install:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt update
  - sudo apt install -y docker-ce
  - docker --version
install:
  - wget http://archive.ubuntu.com/ubuntu/pool/universe/r/rpmlint/rpmlint_1.7-1_all.deb
  - sudo dpkg -i rpmlint_1.7-1_all.deb || sudo apt install -f -y
  - gem install mdl
  - pip install tox
script:
  # First syntax, linting and pre-test stages
  - mdl -s relaxed README.md
  - rpmlint rpm/
  - tox -e pep8,bandit
  # Then unit tests
  - if [[  $TRAVIS_PYTHON_VERSION == 2.7 ]]; then tox -e py27; fi
  - if [[  $TRAVIS_PYTHON_VERSION == 3.4 ]]; then tox -e py34; fi
  # with test coverage
  - tox -e cover,cobertura
  # Extract build version
  - VERSION=$(python setup.py --version)
  # Create a source tarball
  - python setup.py sdist
  # Now, start the build container
  - docker run --name build_container -d -ti -v $PWD:/tmp -w /tmp $OS_NAME:$OS_VERSION /bin/bash -c 'while true ; do sleep 1000 ; done'
  # Install prerequisites for the build
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root build_container yum install -y rpm-build rpmlint; fi
  # and ensure the build paths are present
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root build_container sh -c 'mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}'; fi
  # Install EPEL or OpensStack repositories to get python-pbr
  - if [[ $OS_NAME == 'centos' ]] && [[ $OS_VERSION == '7' ]]; then docker exec -i -w /root build_container yum install -y centos-release-openstack-queens; fi
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root build_container yum install -y python-pbr python-setuptools; fi
  # Copy source tarball to the place rpmbuild expects it
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /tmp build_container sh -c 'cp -v dist/cloud_info_provider*tar.gz ~/rpmbuild/SOURCES'; fi
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /tmp build_container sh -c 'cp -v rpm/*.spec ~/rpmbuild/SPECS'; fi
  # Fix the RPM version when doing an inter-release build, to fix source taball name
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild/SPECS build_container sed -i "s/^(Version.).*/\\1 ${VERSION}/" cloud-info-provider.spec; fi
  # Eventually build the RPMs
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild/SPECS build_container rpmbuild -ba cloud-info-provider.spec; fi
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild/SPECS build_container rpmbuild -ba cloud-info-provider-openstack.spec; fi
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild/SPECS build_container rpmbuild -ba cloud-info-provider-opennebula.spec; fi
  # lint the RPMs
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild build_container sh -c "rpmlint RPMS/"; fi
  # and install them
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild/RPMS/noarch build_container sh -c "yum localinstall -y cloud-info-provider-openstack-*.rpm"; fi
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i -w /root/rpmbuild/RPMS/noarch build_container sh -c "yum localinstall -y cloud-info-provider-opennebula-*.rpm"; fi
  # if it works, get the RPMs we just built to the shared volume
  - if [[ $OS_NAME == 'centos' ]]; then docker exec -i build_container sh -c 'cp -v /root/rpmbuild/RPMS/noarch/*.rpm /tmp'; fi
