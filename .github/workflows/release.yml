---
name: Create new release

on:
  pull_request:
    types:
      - closed

permissions:
  contents: write

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
      changelog: ${{ steps.extract-changelog.outputs.markdown }}
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: Extract version
        id: extract-version
        run: |
          # this uses GNU sed -z!
          version=$(grep "^## \[[0-9].*\]" CHANGELOG.md | \
                    head -1 | sed -e "s/^.*\[\(.*\)\].*/\1/")
          echo "version=$version" >> "$GITHUB_OUTPUT"
      - name: Extract changelog
        id: extract-changelog
        uses: sean0x42/markdown-extract@7b185cbe85263116bbf741e739e7198ba86465dc # v2.1.0
        with:
          file: CHANGELOG.md
          pattern: ${{ steps.extract-version.outputs.version }}
          no-print-matched-heading: true
          name: rpms
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2.3.3
        with:
          tag_name: ${{ steps.extract-version.outputs.version }}
          name: Release ${{ steps.extract-version.outputs.version }}
          body: "${{ steps.extract-changelog.outputs.changelog }}"
